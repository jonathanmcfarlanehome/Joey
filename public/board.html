<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jira‑lite – Board</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 1rem;
    }
    #board {
      display: flex;
      flex-wrap: wrap;
    }
    .column {
      background: #fff;
      border: 1px solid #ccc;
      margin-right: 1rem;
      padding: 0.5rem;
      flex: 1;
      min-width: 200px;
    }
    .card {
      border: 1px solid #999;
      background: #fafafa;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
    }
    select {
      width: 100%;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1 id="title">Board</h1>
  <div id="board"></div>
  <script src="common.js"></script>
  <script>
    requireAuth();
    const params = new URLSearchParams(window.location.search);
    const projectId = params.get('projectId');
    const sprintId = params.get('sprintId');
    async function loadBoard() {
      try {
        // fetch workflow
        const wfRes = await api('/api/projects/' + projectId + '/workflow', { method: 'GET' });
        const workflow = await wfRes.json();
        // fetch board
        const boardRes = await api('/api/projects/' + projectId + '/board' + (sprintId ? '?sprintId=' + sprintId : ''), { method: 'GET' });
        const board = await boardRes.json();
        const container = document.getElementById('board');
        container.innerHTML = '';
        workflow.statuses.forEach((status) => {
          const col = document.createElement('div');
          col.className = 'column';
          const titleEl = document.createElement('h3');
          titleEl.innerText = status;
          col.appendChild(titleEl);
          const issues = board[status] || [];
          issues.forEach((issue) => {
            const card = document.createElement('div');
            card.className = 'card';
            const strong = document.createElement('strong');
            strong.innerText = issue.title;
            card.appendChild(strong);
            const p = document.createElement('p');
            p.innerText = issue.description || '';
            card.appendChild(p);
            const select = document.createElement('select');
            workflow.statuses.forEach((s) => {
              const opt = document.createElement('option');
              opt.value = s;
              opt.text = s;
              if (s === issue.status) opt.selected = true;
              select.appendChild(opt);
            });
            select.addEventListener('change', async () => {
              const newStatus = select.value;
              const res = await api('/api/issues/' + issue.id, {
                method: 'PUT',
                body: JSON.stringify({ status: newStatus }),
              });
              if (res.ok) {
                loadBoard();
              } else {
                const data = await res.json();
                alert(data.error || 'Failed to update status');
              }
            });
            card.appendChild(select);
            col.appendChild(card);
          });
          container.appendChild(col);
        });
      } catch (err) {
        console.error(err);
      }
    }
    loadBoard();
  </script>
</body>
</html>